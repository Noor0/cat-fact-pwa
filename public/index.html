<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="theme-color" content="#ecb961" />

    <link
      rel="/images/apple-touch-icon"
      sizes="57x57"
      href="/apple-icon-57x57.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="60x60"
      href="/apple-icon-60x60.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="72x72"
      href="/apple-icon-72x72.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="76x76"
      href="/apple-icon-76x76.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="114x114"
      href="/apple-icon-114x114.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="120x120"
      href="/apple-icon-120x120.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="144x144"
      href="/apple-icon-144x144.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="152x152"
      href="/apple-icon-152x152.png"
    />
    <link
      rel="/images/apple-touch-icon"
      sizes="180x180"
      href="/apple-icon-180x180.png"
    />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

    <link rel="manifest" href="manifest.json" />
    <link
      href="https://fonts.googleapis.com/css?family=Oxygen&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <title>PWA</title>
  </head>

  <body>
    <div id="container">
      <h1>Cat Fact</h1>
      <p id="fact"></p>
      <button id="aths">Add to home screen</button>
      <button id="push-notif">Enable push notification</button>
      <button id="send">Send me a notification</button>
    </div>
  </body>
  <script src="script.js"></script>
  <script>
    function urlB64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, "+")
        .replace(/_/g, "/");

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    const pushBtn = document.getElementById("push-notif");
    let subscribed;

    function toggleNotificationBtn(isSubscribed) {
      subscribed = isSubscribed;
      if (isSubscribed) {
        pushBtn.innerHTML = "DISABLE Push Notifications";
      } else {
        pushBtn.innerHTML = "ENABLE Push Notifications";
      }
    }

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").then(reg => {
          console.log("registered service worker", reg);

          reg.pushManager.getSubscription().then(sub => {
            console.log({ oldSub: sub });
            if (!sub) toggleNotificationBtn(false);
            else toggleNotificationBtn(true);
          });

          pushBtn.addEventListener("click", async e => {
            const hasPermission = window.Notification.permission === "granted";
            if (!hasPermission) {
              await window.Notification.requestPermission();
            }
            if (!subscribed && hasPermission) {
              const applicationServerPublicKey =
                "BOagsDf_-tNHQeP5OKqqw4mgw7LycsU3FODH8sQoJFhpIu63ZHIBf2E9meq3Rn6uWnDxRUMocJ5RHi2P1re4opI";
              const applicationServerKey = urlB64ToUint8Array(
                applicationServerPublicKey
              );
              reg.pushManager
                .subscribe({ userVisibleOnly: true, applicationServerKey })
                .then(sub => {
                  const subscription = JSON.parse(JSON.stringify(sub));
                  fetch("/subscribe", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: subscription, ho: "hp" })
                  });
                  console.log(subscription);
                  if (!sub) {
                    toggleNotificationBtn(false);
                  } else {
                    toggleNotificationBtn(true);
                  }
                });
            } else if (hasPermission) {
              reg.pushManager
                .getSubscription()
                .then(sub => {
                  if (!sub) throw new Error("");
                  return sub.unsubscribe();
                })
                .then(() => {
                  toggleNotificationBtn(false);
                })
                .catch(err => {
                  console.log("Error while unsubscribing", err);
                });
            }
          });

          reg.pushManager.getSubscription(sub => {
            if (!sub) {
              toggleNotificationBtn(false);
            } else {
              toggleNotificationBtn(true);
            }
          });
        });

        navigator.serviceWorker.ready.then(reg => {
          console.log("READY");
        });

        //     var options = {
        //       body: "This is my body!",
        //       icon: "images/icon-192.png",
        //       vibrate: [100, 50, 100],
        //       data: {
        //         dateOfArrival: Date.now(),
        //         primaryKey: 1
        //       },
        //       actions: [
        //         {
        // action: "explore",
        // title: "Explore",
        //           icon: "images/explore.png"
        //         },
        //         {
        //           action: "check",
        //           title: "Focus",
        //           icon: "images/checkmark.png"
        //         }
        //       ]
        //     };
        //     reg.showNotification("Push Notification", options);
      });
    }
  </script>
</html>
